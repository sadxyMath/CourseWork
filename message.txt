from fastapi import APIRouter, HTTPException, status, Depends
from sqlalchemy.orm import Session
from fastapi.security.oauth2 import OAuth2PasswordRequestForm
from backend.app import database, schemes, models, utils, oauth2

router = APIRouter(tags=["–õ–æ–≥–∏–Ω"])

@router.post("/login", response_model=schemes.TokenModel)
def login(
    user_credentials: OAuth2PasswordRequestForm = Depends(),
    db: Session = Depends(database.get_db)
):
    # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    user = db.query(models.User).filter(models.User.phone == user_credentials.username).first()
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
        )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    if not utils.verify(user_credentials.password, user.hashed_password):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
        )

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω (–≤–∫–ª—é—á–∞–µ–º tenant_id)
    access_token = oauth2.create_access_token(data={
        "user_id": user.id,
        "tenant_id": user.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞,  # –º–æ–∂–µ—Ç –±—ã—Ç—å None –¥–ª—è –∞–¥–º–∏–Ω–æ–≤/—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        "user_role": user.role
    })

    return {"access_token": access_token, "token_type": "bearer"}

from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List
from backend.app import models, schemes
from backend.app.database import get_db
from backend.app.dependencies import require_role

router = APIRouter(
    prefix="/bookings",
    tags=["–ë—Ä–æ–Ω–∏"],
)

@router.get("/", response_model=List[schemes.BookingOut])
def get_all_bookings(
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin", "tenant", "staff"]))
):
    if current_user.role in ["admin", "staff"]:
        return db.query(models.Booking).all()
    elif current_user.role == "tenant":
        tenant_id = current_user.tenant_id
        user_bookings = db.query(models.Booking).filter(
            models.Booking.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == tenant_id
        ).all()
        if not user_bookings:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Å–æ–≤. –ß—Ç–æ–±—ã —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –æ—Ñ–∏—Å–æ–≤"
            )
        return user_bookings


@router.post("/", response_model=schemes.BookingOut, status_code=status.HTTP_201_CREATED)
def create_booking(
    booking: schemes.BookingCreate,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["tenant", "admin"]))
):
    tenant_id = current_user.tenant_id if current_user.role == "tenant" else booking.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞

    office = db.query(models.Office).filter(models.Office.id_–æ—Ñ–∏—Å–∞ == booking.id_–æ—Ñ–∏—Å–∞).first()
    if not office:
        raise HTTPException(status_code=400, detail="–£–∫–∞–∑–∞–Ω–Ω—ã–π –æ—Ñ–∏—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    existing = db.query(models.Booking).filter(
        models.Booking.id_–æ—Ñ–∏—Å–∞ == booking.id_–æ—Ñ–∏—Å–∞,
        models.Booking.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == tenant_id
    ).first()
    if existing:
        raise HTTPException(status_code=400, detail="–í—ã —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –æ—Ñ–∏—Å")

    if booking.–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏ < booking.–Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞")

    overlap = db.query(models.Booking).filter(
        models.Booking.id_–æ—Ñ–∏—Å–∞ == booking.id_–æ—Ñ–∏—Å–∞,
        models.Booking.–Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏ < booking.–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏,
        models.Booking.–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏ > booking.–Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏
    ).first()
    if overlap:
        raise HTTPException(status_code=400, detail="–û—Ñ–∏—Å —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥")

    new_booking = models.Booking(
        id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞=tenant_id,
        **booking.dict()
    )
    db.add(new_booking)
    db.commit()
    db.refresh(new_booking)
    return new_booking


@router.put("/{booking_id}", response_model=schemes.BookingOut)
def update_booking(
    booking_id: int,
    updated: schemes.BookingUpdate,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin", "tenant"]))
):
    booking = db.query(models.Booking).filter(models.Booking.id_–±—Ä–æ–Ω–∏ == booking_id).first()
    if not booking:
        raise HTTPException(status_code=404, detail="–ë—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    if current_user.role == "tenant" and booking.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.tenant_id:
        raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –±—Ä–æ–Ω–∏")

    start_date = updated.–Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏ or booking.–Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏
    end_date = updated.–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏ or booking.–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏
    if end_date < start_date:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞")

    conflict = db.query(models.Booking).filter(
        models.Booking.id_–æ—Ñ–∏—Å–∞ == booking.id_–æ—Ñ–∏—Å–∞,
        models.Booking.id_–±—Ä–æ–Ω–∏ != booking_id,
        models.Booking.–Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏ < end_date,
        models.Booking.–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏ > start_date
    ).first()
    if conflict:
        raise HTTPException(status_code=400, detail="–û—Ñ–∏—Å —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥")

    for key, value in updated.dict(exclude_unset=True).items():
        setattr(booking, key, value)

    db.commit()
    db.refresh(booking)
    return booking


@router.delete("/{booking_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_booking(
    booking_id: int,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin", "tenant"]))
):
    booking = db.query(models.Booking).filter(models.Booking.id_–±—Ä–æ–Ω–∏ == booking_id).first()
    if not booking:
        raise HTTPException(status_code=404, detail="–ë—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    if current_user.role == "tenant" and booking.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.tenant_id:
        raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –±—Ä–æ–Ω–∏")

    db.delete(booking)
    db.commit()
    return None


from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List

from backend.app import models, schemes
from backend.app.database import get_db
from backend.app.dependencies import require_role

router = APIRouter(
    prefix="/contracts",
    tags=["–î–æ–≥–æ–≤–æ—Ä—ã"],
)

# =======================
# GET /contracts ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤
# =======================
@router.get("/", response_model=List[schemes.ContractOut])
def get_contracts(
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin", "tenant"]))
):
    if current_user.role == "admin":
        return db.query(models.Contract).all()
    elif current_user.role == "tenant":
        return db.query(models.Contract).filter(
            models.Contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == current_user.tenant_id
        ).all()


# =======================
# GET /contracts/{id} ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞
# =======================
@router.get("/{contract_id}", response_model=schemes.ContractOut)
def get_contract(
    contract_id: int,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin", "tenant"]))
):
    contract = db.query(models.Contract).filter(models.Contract.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == contract_id).first()
    if not contract:
        raise HTTPException(status_code=404, detail="–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    if current_user.role == "tenant" and contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.tenant_id:
        raise HTTPException(status_code=403, detail="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –¥–æ–≥–æ–≤–æ—Ä—É")

    return contract


# =======================
# POST /contracts ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞
# (—Ç–æ–ª—å–∫–æ admin)
# =======================
@router.post("/", response_model=schemes.ContractOut, status_code=status.HTTP_201_CREATED)
def create_contract(
    contract: schemes.ContractCreate,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin"]))
):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ñ–∏—Å–∞
    office = db.query(models.Office).filter(models.Office.id_–æ—Ñ–∏—Å–∞ == contract.id_–æ—Ñ–∏—Å–∞).first()
    if not office:
        raise HTTPException(status_code=404, detail="–û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    if office.—Å—Ç–∞—Ç—É—Å != "—Å–≤–æ–±–æ–¥–µ–Ω":
        raise HTTPException(status_code=400, detail="–û—Ñ–∏—Å —É–∂–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞—Ä–µ–Ω–¥—ã")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
    tenant = db.query(models.Tenant).filter(models.Tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞).first()
    if not tenant:
        raise HTTPException(status_code=400, detail="–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –¥–∞—Ç
    if contract.–¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è < contract.–¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞")

    db_contract = models.Contract(**contract.dict())
    db.add(db_contract)

    # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ñ–∏—Å–∞
    office.—Å—Ç–∞—Ç—É—Å = "–∞—Ä–µ–Ω–¥—É–µ—Ç—Å—è"

    db.commit()
    db.refresh(db_contract)
    return db_contract


# =======================
# PUT /contracts/{id} ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞
# (—Ç–æ–ª—å–∫–æ admin)
# =======================
@router.put("/{contract_id}", response_model=schemes.ContractOut)
def update_contract(
    contract_id: int,
    updated: schemes.ContractUpdate,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin"]))
):
    db_contract = db.query(models.Contract).filter(models.Contract.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == contract_id).first()
    if not db_contract:
        raise HTTPException(status_code=404, detail="–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –¥–∞—Ç
    start = updated.–¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞ or db_contract.–¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞
    end = updated.–¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è or db_contract.–¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è
    if end < start:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞")

    for key, value in updated.dict(exclude_unset=True).items():
        setattr(db_contract, key, value)

    db.commit()
    db.refresh(db_contract)
    return db_contract


# =======================
# DELETE /contracts/{id} ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞
# (—Ç–æ–ª—å–∫–æ admin)
# =======================
@router.delete("/{contract_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_contract(
    contract_id: int,
    db: Session = Depends(get_db),
    current_user: schemes.TokenData = Depends(require_role(["admin"]))
):
    db_contract = db.query(models.Contract).filter(models.Contract.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == contract_id).first()
    if not db_contract:
        raise HTTPException(status_code=404, detail="–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –æ—Ñ–∏—Å, –µ—Å–ª–∏ —Å–≤—è–∑–∞–Ω
    if hasattr(db_contract, "–æ—Ñ–∏—Å") and db_contract.–æ—Ñ–∏—Å:
        db_contract.–æ—Ñ–∏—Å.—Å—Ç–∞—Ç—É—Å = "—Å–≤–æ–±–æ–¥–µ–Ω"

    db.delete(db_contract)
    db.commit()
    return None


from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from typing import List, Optional

from backend.app.database import get_db
from backend.app.models import Office
from backend.app.schemes import OfficeOut, OfficeCreate, OfficeUpdate
from backend.app.dependencies import require_role

router = APIRouter(
    prefix="/offices",
    tags=["–û—Ñ–∏—Å—ã"]
)

# --------------------------
# GET all offices (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)
# --------------------------
@router.get("/", response_model=List[OfficeOut])
def get_offices(
    status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –æ—Ñ–∏—Å–∞ (—Å–≤–æ–±–æ–¥–µ–Ω/–∞—Ä–µ–Ω–¥—É–µ—Ç—Å—è)"),
    floor: Optional[int] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–∂—É"),
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin", "tenant", "staff"]))
):
    query = db.query(Office)

    if status:
        query = query.filter(Office.—Å—Ç–∞—Ç—É—Å == status)
    if floor:
        query = query.filter(Office.—ç—Ç–∞–∂ == floor)

    offices = query.all()
    if not offices:
        raise HTTPException(status_code=404, detail="–û—Ñ–∏—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    return offices


# --------------------------
# GET single office
# --------------------------
@router.get("/{office_id}", response_model=OfficeOut)
def get_office(
    office_id: int,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin", "tenant", "staff"]))
):
    office = db.query(Office).filter(Office.id_–æ—Ñ–∏—Å–∞ == office_id).first()
    if not office:
        raise HTTPException(status_code=404, detail="–û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    return office


# --------------------------
# CREATE office (—Ç–æ–ª—å–∫–æ admin)
# --------------------------
@router.post("/", response_model=OfficeOut, status_code=status.HTTP_201_CREATED)
def create_office(
    office: OfficeCreate,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin"]))
):
    existing_office = db.query(Office).filter(Office.–Ω–æ–º–µ—Ä_–æ—Ñ–∏—Å–∞ == office.–Ω–æ–º–µ—Ä_–æ—Ñ–∏—Å–∞).first()
    if existing_office:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–¢–∞–∫–æ–π –æ—Ñ–∏—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    db_office = Office(**office.dict())
    db.add(db_office)
    db.commit()
    db.refresh(db_office)
    return db_office


# --------------------------
# UPDATE office (—Ç–æ–ª—å–∫–æ admin)
# --------------------------
@router.put("/{office_id}", response_model=OfficeOut)
def update_office(
    office_id: int,
    office: OfficeUpdate,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin"]))
):
    db_office = db.query(Office).filter(Office.id_–æ—Ñ–∏—Å–∞ == office_id).first()
    if not db_office:
        raise HTTPException(status_code=404, detail="–û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    for key, value in office.dict(exclude_unset=True).items():
        setattr(db_office, key, value)

    db.commit()
    db.refresh(db_office)
    return db_office


# --------------------------
# DELETE office (—Ç–æ–ª—å–∫–æ admin)
# --------------------------
@router.delete("/{office_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_office(
    office_id: int,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin"]))
):
    db_office = db.query(Office).filter(Office.id_–æ—Ñ–∏—Å–∞ == office_id).first()
    if not db_office:
        raise HTTPException(status_code=404, detail="–û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    db.delete(db_office)
    db.commit()
    return None
    
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List
from datetime import date

from backend.app.database import get_db
from backend.app.models import Payment, Contract
from backend.app.schemes import PaymentOut, PaymentCreate, PaymentUpdate
from backend.app.dependencies import require_role

router = APIRouter(
    prefix="/payments",
    tags=["–ü–ª–∞—Ç–µ–∂–∏"]
)

# üîπ –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏
@router.get("/", response_model=List[PaymentOut])
def get_payments(
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin", "tenant", "staff"]))
):
    if current_user.role in ["admin", "staff"]:
        return db.query(Payment).all()

    # tenant –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø–ª–∞—Ç–µ–∂–∏
    return (
        db.query(Payment)
        .join(Contract)
        .filter(Contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == current_user.tenant_id)
        .all()
    )


# üîπ –ü–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω –ø–ª–∞—Ç–µ–∂
@router.get("/{payment_id}", response_model=PaymentOut)
def get_payment(
    payment_id: int,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin", "tenant", "staff"]))
):
    payment = db.query(Payment).filter(Payment.id_–ø–ª–∞—Ç–µ–∂–∞ == payment_id).first()
    if not payment:
        raise HTTPException(status_code=404, detail="–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
    if current_user.role == "tenant":
        contract = db.query(Contract).filter(Contract.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == payment.id_–¥–æ–≥–æ–≤–æ—Ä–∞).first()
        if not contract or contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.tenant_id:
            raise HTTPException(status_code=403, detail="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –ø–ª–∞—Ç–µ–∂—É")

    return payment


# üîπ –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
@router.post("/", response_model=PaymentOut, status_code=status.HTTP_201_CREATED)
def create_payment(
    payment: PaymentCreate,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin", "tenant"]))
):
    contract = db.query(Contract).filter(Contract.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == payment.id_–¥–æ–≥–æ–≤–æ—Ä–∞).first()
    if not contract:
        raise HTTPException(status_code=404, detail="–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if current_user.role == "tenant" and contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.tenant_id:
        raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤")

    if payment.–¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞ < contract.–¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞:
        raise HTTPException(status_code=400, detail="–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –¥–æ–≥–æ–≤–æ—Ä–∞")

    if contract.—Å—Ç–∞—Ç—É—Å == "—Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç":
        raise HTTPException(status_code=400, detail="–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –∫ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç–æ–º—É –¥–æ–≥–æ–≤–æ—Ä—É")

    db_payment = Payment(**payment.dict())
    db.add(db_payment)
    db.commit()
    db.refresh(db_payment)
    return db_payment


# üîπ –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂ ‚Äî —Ç–æ–ª—å–∫–æ admin
@router.put("/{payment_id}", response_model=PaymentOut)
def update_payment(
    payment_id: int,
    payment: PaymentUpdate,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin"]))
):
    db_payment = db.query(Payment).filter(Payment.id_–ø–ª–∞—Ç–µ–∂–∞ == payment_id).first()
    if not db_payment:
        raise HTTPException(status_code=404, detail="–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")

    for key, value in payment.dict(exclude_unset=True).items():
        setattr(db_payment, key, value)

    db.commit()
    db.refresh(db_payment)
    return db_payment


# üîπ –£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂ ‚Äî —Ç–æ–ª—å–∫–æ admin
@router.delete("/{payment_id}", status_code=status.HTTP_204_NO_CONTENT)
def delete_payment(
    payment_id: int,
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin"]))
):
    db_payment = db.query(Payment).filter(Payment.id_–ø–ª–∞—Ç–µ–∂–∞ == payment_id).first()
    if not db_payment:
        raise HTTPException(status_code=404, detail="–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")

    db.delete(db_payment)
    db.commit()
    return None


# üîπ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ ‚Äî admin –∏ staff
@router.post("/check-overdue", response_model=dict)
def check_overdue_payments(
    db: Session = Depends(get_db),
    current_user = Depends(require_role(["admin", "staff"]))
):
    today = date.today()
    overdue = (
        db.query(Payment)
        .filter(Payment.–¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞ < today, Payment.—Å—Ç–∞—Ç—É—Å == "–Ω–µ –æ–ø–ª–∞—á–µ–Ω")
        .all()
    )

    for pay in overdue:
        pay.—Å—Ç–∞—Ç—É—Å = "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω"

    db.commit()
    return {"detail": f"–û–±–Ω–æ–≤–ª–µ–Ω–æ {len(overdue)} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π"}


from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from backend.app.database import get_db
from backend.app.models import User, Tenant
from backend.app.schemes import UserCreate
from backend.app import utils, oauth2

router = APIRouter(
    tags=["–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è"]
)

@router.post("/register", status_code=status.HTTP_201_CREATED)
def register(user_data: UserCreate, db: Session = Depends(get_db)):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ username/—Ç–µ–ª–µ—Ñ–æ–Ω–∞
    existing_user = db.query(User).filter(User.phone == user_data.username).first()
    if existing_user:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
    existing_tenant = db.query(Tenant).filter(
        Tenant.–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ == user_data.contact_person,
        Tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏ == user_data.company_name
    ).first()
    if existing_tenant:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    # –°–æ–∑–¥–∞—ë–º –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
    tenant = Tenant(
        –Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏=user_data.company_name,
        –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ=user_data.contact_person,
        —Ç–µ–ª–µ—Ñ–æ–Ω=user_data.username
    )
    db.add(tenant)
    db.commit()
    db.refresh(tenant)

    # –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User(
        phone=user_data.username,
        hashed_password=utils.hash(user_data.password),
        role="tenant",
        id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞=tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
    )
    db.add(user)
    db.commit()
    db.refresh(user)

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω —Å tenant_id
    access_token = oauth2.create_access_token(
        data={
            "user_id": user.id,
            "tenant_id": user.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞,
            "user_role": user.role
        }
    )

    return {
        "access_token": access_token,
        "token_type": "bearer",
        "user": {
            "id": user.id,
            "phone": user.phone,
            "role": user.role,
            "tenant_id": user.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
        }
    }


ffrom fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from datetime import date

from backend.app.database import get_db
from backend.app.models import Request, Contract, Office
from backend.app.schemes import RequestOut, RequestCreate, RequestUpdate
from backend.app.dependencies import require_role

router = APIRouter(
    prefix="/requests",
    tags=["–ó–∞—è–≤–∫–∏"]
)

# --------------------------
# GET all requests —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
# --------------------------
@router.get("/", response_model=List[RequestOut])
def get_all_requests(
    status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É –∑–∞—è–≤–∫–∏"),
    contract_id: Optional[int] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ ID –¥–æ–≥–æ–≤–æ—Ä–∞"),
    date_from: Optional[date] = Query(None),
    date_to: Optional[date] = Query(None),
    db: Session = Depends(get_db),
    current_user=Depends(require_role(["admin", "tenant", "staff"]))
):
    query = db.query(Request)

    if current_user.role == "tenant":
        query = query.join(Contract).filter(Contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == current_user.id)

    if status:
        query = query.filter(Request.—Å—Ç–∞—Ç—É—Å == status)
    if contract_id:
        query = query.filter(Request.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == contract_id)
    if date_from:
        query = query.filter(Request.–¥–∞—Ç–∞_–ø–æ–¥–∞—á–∏ >= date_from)
    if date_to:
        query = query.filter(Request.–¥–∞—Ç–∞_–ø–æ–¥–∞—á–∏ <= date_to)

    return query.all()

# --------------------------
# GET single request —Å info –æ –¥–æ–≥–æ–≤–æ—Ä–µ –∏ –æ—Ñ–∏—Å–µ
# --------------------------
@router.get("/{request_id}", response_model=RequestOut)
def get_request(
    request_id: int,
    db: Session = Depends(get_db),
    current_user=Depends(require_role(["admin", "tenant", "staff"]))
):
    req = db.query(Request).filter(Request.id_–∑–∞—è–≤–∫–∏ == request_id).first()
    if not req:
        raise HTTPException(status_code=404, detail="–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    if current_user.role == "tenant" and req.–¥–æ–≥–æ–≤–æ—Ä.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.id:
        raise HTTPException(status_code=403, detail="–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ")

    # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–≥–æ–≤–æ—Ä–µ –∏ –æ—Ñ–∏—Å–µ
    req.–æ—Ñ–∏—Å = req.–¥–æ–≥–æ–≤–æ—Ä.–æ—Ñ–∏—Å if hasattr(req.–¥–æ–≥–æ–≤–æ—Ä, "–æ—Ñ–∏—Å") else None

    return req

# --------------------------
# CREATE request
# --------------------------
@router.post("/", response_model=RequestOut, status_code=status.HTTP_201_CREATED)
def create_request(
    request: RequestCreate,
    db: Session = Depends(get_db),
    current_user=Depends(require_role(["admin", "tenant"]))
):
    contract = db.query(Contract).filter(Contract.id_–¥–æ–≥–æ–≤–æ—Ä–∞ == request.id_–¥–æ–≥–æ–≤–æ—Ä–∞).first()
    if not contract:
        raise HTTPException(status_code=404, detail="–î–æ–≥–æ–≤–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if current_user.role == "tenant" and contract.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.id:
        raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤")

    new_request = Request(**request.dict())
    db.add(new_request)
    db.commit()
    db.refresh(new_request)
    return new_request

# --------------------------
# UPDATE request
# --------------------------
@router.put("/{request_id}", response_model=RequestOut)
def update_request(
    request_id: int,
    updated: RequestUpdate,
    db: Session = Depends(get_db),
    current_user=Depends(require_role(["admin", "tenant", "staff"]))
):
    req = db.query(Request).filter(Request.id_–∑–∞—è–≤–∫–∏ == request_id).first()
    if not req:
        raise HTTPException(status_code=404, detail="–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    # Tenant –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏, –∫—Ä–æ–º–µ —Å—Ç–∞—Ç—É—Å–∞
    if current_user.role == "tenant":
        if req.–¥–æ–≥–æ–≤–æ—Ä.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.id:
            raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏")
        for key, value in updated.dict(exclude_unset=True).items():
            if key != "—Å—Ç–∞—Ç—É—Å":
                setattr(req, key, value)
    # Staff –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å
    elif current_user.role == "staff":
        if updated.—Å—Ç–∞—Ç—É—Å is None:
            raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏")
        req.—Å—Ç–∞—Ç—É—Å = updated.—Å—Ç–∞—Ç—É—Å
    # Admin –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –≤—Å—ë
    else:
        for key, value in updated.dict(exclude_unset=True).items():
            setattr(req, key, value)

    db.commit()
    db.refresh(req)
    return req

# --------------------------
# DELETE request
# --------------------------
@router.delete("/{request_id}", status_code=status.HTTP_200_OK)
def delete_request(
    request_id: int,
    db: Session = Depends(get_db),
    current_user=Depends(require_role(["admin", "tenant"]))
):
    req = db.query(Request).filter(Request.id_–∑–∞—è–≤–∫–∏ == request_id).first()
    if not req:
        raise HTTPException(status_code=404, detail="–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    if current_user.role == "tenant" and req.–¥–æ–≥–æ–≤–æ—Ä.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != current_user.id:
        raise HTTPException(status_code=403, detail="–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏")

    db.delete(req)
    db.commit()
    return {"detail": "–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞"}


from fastapi import APIRouter, HTTPException, status, Depends
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List, Optional
from backend.app import models, schemes, database
from backend.app.dependencies import require_role

router = APIRouter(
    prefix="/tenants",
    tags=["–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"]
)

# --------------------------
# GET /tenants ‚Äî —Å–ø–∏—Å–æ–∫ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
# --------------------------
@router.get("/", response_model=List[schemes.TenantOut])
def get_all_tenants(
    name: Optional[str] = None,
    phone: Optional[str] = None,
    db: Session = Depends(database.get_db),
    current_user = Depends(require_role(["admin", "staff"]))
):
    query = db.query(models.Tenant)
    if name:
        query = query.filter(
            or_(
                models.Tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏.ilike(f"%{name}%"),
                models.Tenant.–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ.ilike(f"%{name}%")
            )
        )
    if phone:
        query = query.filter(models.Tenant.—Ç–µ–ª–µ—Ñ–æ–Ω.ilike(f"%{phone}%"))
    return query.all()

# --------------------------
# GET /tenants/{id} ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä
# --------------------------
@router.get("/{tenant_id}", response_model=schemes.TenantOut)
def get_tenant(
    tenant_id: int,
    db: Session = Depends(database.get_db),
    current_user = Depends(require_role(["admin", "staff"]))
):
    tenant = db.query(models.Tenant).filter(models.Tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == tenant_id).first()
    if not tenant:
        raise HTTPException(status_code=404, detail="Tenant not found")
    return tenant

# --------------------------
# POST /tenants ‚Äî —Å–æ–∑–¥–∞—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
# --------------------------
@router.post("/", response_model=schemes.TenantOut, status_code=status.HTTP_201_CREATED)
def create_tenant(
    tenant: schemes.TenantCreate,
    db: Session = Depends(database.get_db),
    current_user = Depends(require_role(["admin"]))
):
    # –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
    existing = db.query(models.Tenant).filter(
        or_(
            models.Tenant.—Ç–µ–ª–µ—Ñ–æ–Ω == tenant.—Ç–µ–ª–µ—Ñ–æ–Ω,
            models.Tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏ == tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏
        )
    ).first()
    if existing:
        raise HTTPException(status_code=status.HTTP_409_CONFLICT,
                            detail="–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–æ–º–ø–∞–Ω–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    db_tenant = models.Tenant(**tenant.dict())
    db.add(db_tenant)
    db.commit()
    db.refresh(db_tenant)
    return db_tenant

# --------------------------
# PUT /tenants/{id} ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
# --------------------------
@router.put("/{tenant_id}", response_model=schemes.TenantOut)
def update_tenant(
    tenant_id: int,
    tenant: schemes.TenantUpdate,
    db: Session = Depends(database.get_db),
    current_user = Depends(require_role(["admin"]))
):
    db_tenant = db.query(models.Tenant).filter(models.Tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == tenant_id).first()
    if not db_tenant:
        raise HTTPException(status_code=404, detail="Tenant not found")

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if tenant.—Ç–µ–ª–µ—Ñ–æ–Ω:
        existing_phone = db.query(models.Tenant).filter(
            models.Tenant.—Ç–µ–ª–µ—Ñ–æ–Ω == tenant.—Ç–µ–ª–µ—Ñ–æ–Ω,
            models.Tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != tenant_id
        ).first()
        if existing_phone:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–¢–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è")

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
    if tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏:
        existing_name = db.query(models.Tenant).filter(
            models.Tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏ == tenant.–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏,
            models.Tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ != tenant_id
        ).first()
        if existing_name:
            raise HTTPException(status_code=status.HTTP_409_CONFLICT, detail="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è")

    for key, value in tenant.dict(exclude_unset=True).items():
        setattr(db_tenant, key, value)

    db.commit()
    db.refresh(db_tenant)
    return db_tenant


# --------------------------
# DELETE /tenants/{id} ‚Äî —É–¥–∞–ª–∏—Ç—å –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞
# --------------------------
@router.delete("/{tenant_id}", response_model=dict)
def delete_tenant(
    tenant_id: int,
    db: Session = Depends(database.get_db),
    current_user = Depends(require_role(["admin"]))
):
    db_tenant = db.query(models.Tenant).filter(models.Tenant.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ == tenant_id).first()
    if not db_tenant:
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail="Tenant not found")

    db.delete(db_tenant)
    db.commit()
    return {"detail": "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä —É–¥–∞–ª—ë–Ω"}


from jose import JWTError, jwt
from datetime import datetime, timedelta
from fastapi import Depends, status, HTTPException
from fastapi.security import OAuth2PasswordBearer
from backend.app import schemes
from backend.app.config import settings

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="login")

SECRET_KEY = settings.secret_key
ALGORITHM = settings.algorithm
ACCESS_TOKEN_EXPIRE_MINUTES = settings.access_token_expire_minutes


def create_access_token(data: dict):
    to_encode = data.copy()
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})
    return jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)


def verify_access_token(token: str, credentials_exception):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id = payload.get("user_id")
        tenant_id = payload.get("tenant_id")
        role = payload.get("user_role")

        if user_id is None or role is None:
            raise credentials_exception

        return schemes.TokenData(id=int(user_id), role=role, tenant_id=tenant_id)
    except JWTError:
        raise credentials_exception



def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
        headers={"WWW-Authenticate": "Bearer"},
    )
    return verify_access_token(token, credentials_exception)


from pydantic import BaseModel, Field, constr, conint
from datetime import date
from typing import Optional, List


# –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä

class TenantBase(BaseModel):
    –Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏: constr(max_length=100)
    –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ: constr(max_length=100)
    —Ç–µ–ª–µ—Ñ–æ–Ω: constr(max_length=20)

class TenantCreate(TenantBase):
    pass

class TenantUpdate(BaseModel):
    –Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏: Optional[constr(max_length=100)]
    –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ: Optional[constr(max_length=100)]
    —Ç–µ–ª–µ—Ñ–æ–Ω: Optional[constr(max_length=20)]

class TenantOut(TenantBase):
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: int
    –¥–∞—Ç–∞_—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: date

    class Config:
        from_attributes = True


# –û—Ñ–∏—Å

class OfficeBase(BaseModel):
    –Ω–æ–º–µ—Ä_–æ—Ñ–∏—Å–∞: constr(max_length=10)
    —ç—Ç–∞–∂: conint(ge=1)
    –ø–ª–æ—â–∞–¥—å: conint(gt=0)
    —Å—Ç–æ–∏–º–æ—Å—Ç—å: conint(gt=0)
    —Å—Ç–∞—Ç—É—Å: constr(max_length=20)

class OfficeCreate(OfficeBase):
    pass

class OfficeUpdate(BaseModel):
    –Ω–æ–º–µ—Ä_–æ—Ñ–∏—Å–∞: Optional[constr(max_length=10)]
    —ç—Ç–∞–∂: Optional[conint(ge=1)]
    –ø–ª–æ—â–∞–¥—å: Optional[conint(gt=0)]
    —Å—Ç–æ–∏–º–æ—Å—Ç—å: Optional[conint(gt=0)]
    —Å—Ç–∞—Ç—É—Å: Optional[constr(max_length=20)]

class OfficeOut(OfficeBase):
    id_–æ—Ñ–∏—Å–∞: int

    class Config:
        from_attributes = True


# –î–æ–≥–æ–≤–æ—Ä

class ContractBase(BaseModel):
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: int
    id_–æ—Ñ–∏—Å–∞: int
    –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞: date
    –¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è: date
    —Å—Ç–æ–∏–º–æ—Å—Ç—å: conint(gt=0)
    —Å—Ç–∞—Ç—É—Å: constr(max_length=20)

class ContractCreate(ContractBase):
    pass

class ContractUpdate(BaseModel):
    –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞: Optional[date]
    –¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è: Optional[date]
    —Å—Ç–æ–∏–º–æ—Å—Ç—å: Optional[conint(gt=0)]
    —Å—Ç–∞—Ç—É—Å: Optional[constr(max_length=20)]

class ContractOut(ContractBase):
    id_–¥–æ–≥–æ–≤–æ—Ä–∞: int
    –¥–∞—Ç–∞_–∑–∞–∫–ª—é—á–µ–Ω–∏—è: date
    class Config:
        from_attributes = True


# –ü–ª–∞—Ç—ë–∂

class PaymentBase(BaseModel):
    id_–¥–æ–≥–æ–≤–æ—Ä–∞: int
    —Å—Ä–æ–∫_–æ–ø–ª–∞—Ç—ã: date
    —Å—É–º–º–∞: conint(gt=0)
    —Å—Ç–∞—Ç—É—Å: constr(max_length=20)
    –¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞: Optional[date]

class PaymentCreate(PaymentBase):
    pass

class PaymentUpdate(BaseModel):
    —Å—Ä–æ–∫_–æ–ø–ª–∞—Ç—ã: Optional[date]
    —Å—É–º–º–∞: Optional[conint(gt=0)]
    —Å—Ç–∞—Ç—É—Å: Optional[constr(max_length=20)]
    –¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞: Optional[date]

class PaymentOut(PaymentBase):
    id_–ø–ª–∞—Ç–µ–∂–∞: int
    –¥–∞—Ç–∞_—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: date

    class Config:
        from_attributes = True


# –ó–∞—è–≤–∫–∞

class RequestBase(BaseModel):
    id_–¥–æ–≥–æ–≤–æ—Ä–∞: int
    —Å—Ç–∞—Ç—É—Å: constr(max_length=20)
    —Ç–µ–∫—Å—Ç_–∑–∞—è–≤–∫–∏: constr(max_length=500)

class RequestCreate(RequestBase):
    pass

class RequestUpdate(BaseModel):
    —Å—Ç–∞—Ç—É—Å: Optional[constr(max_length=20)]
    —Ç–µ–∫—Å—Ç_–∑–∞—è–≤–∫–∏: Optional[constr(max_length=500)]

class RequestOut(RequestBase):
    id_–∑–∞—è–≤–∫–∏: int
    –¥–∞—Ç–∞_–ø–æ–¥–∞—á–∏: date

    class Config:
        from_attributes = True


# –ë—Ä–æ–Ω—å

class BookingBase(BaseModel):
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: int
    id_–æ—Ñ–∏—Å–∞: int
    –Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏: date
    –æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏: date
    —Å—Ç–∞—Ç—É—Å: constr(max_length=20)

class BookingCreate(BaseModel):
    id_–æ—Ñ–∏—Å–∞: int
    –Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏: date
    –æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏: date
    —Å—Ç–∞—Ç—É—Å: constr(max_length=20)

class BookingUpdate(BaseModel):
    –Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏: Optional[date]
    –æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏: Optional[date]
    —Å—Ç–∞—Ç—É—Å: Optional[constr(max_length=20)]

class BookingOut(BookingBase):
    id_–±—Ä–æ–Ω–∏: int
    –¥–∞—Ç–∞_–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: date

    class Config:
        from_attributes = True

#–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

class UserCreate(BaseModel):
    username: constr(min_length=4)
    password: constr(min_length=6)
    company_name: str
    contact_person: str

class UserLogin(BaseModel):
    username: str
    password: str

class UserOut(BaseModel):
    id: int
    phone: str
    role: str
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞: int | None

    class Config:
        from_attributes = True


 #–¢–æ–∫–µ–Ω
class TokenData(BaseModel):
    id: int
    role: str
    tenant_id: Optional[int] = None

class TokenModel(BaseModel):
    access_token: str
    token_type: str

class TokenDataForPersonal(BaseModel):
    role: str

from sqlalchemy import Column, ForeignKey, Integer, String, text, func, CheckConstraint, Date
from .database import Base
from sqlalchemy.orm import relationship
import datetime

class Tenant(Base):
    __tablename__ = "–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä"

    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ = Column(Integer, primary_key=True, index=True)
    –Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–æ–º–ø–∞–Ω–∏–∏ = Column(String(100), nullable=False)
    –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ_–ª–∏—Ü–æ = Column(String(100), nullable=False)
    —Ç–µ–ª–µ—Ñ–æ–Ω = Column(String(20), nullable=False, unique=True)
    –¥–∞—Ç–∞_—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ = Column(Date, nullable=False, server_default=func.current_date())


class Office(Base):
    __tablename__ = "–æ—Ñ–∏—Å"

    id_–æ—Ñ–∏—Å–∞ = Column(Integer, primary_key=True, index=True)
    –Ω–æ–º–µ—Ä_–æ—Ñ–∏—Å–∞ = Column(String(10), nullable=False)
    —ç—Ç–∞–∂ = Column(Integer, nullable=False)
    –ø–ª–æ—â–∞–¥—å = Column(Integer, nullable=False)
    —Å—Ç–æ–∏–º–æ—Å—Ç—å = Column(Integer, nullable=False)
    —Å—Ç–∞—Ç—É—Å = Column(String(20), nullable=False)

    __table_args__ = (
        CheckConstraint("—ç—Ç–∞–∂ >= 1", name="check_—ç—Ç–∞–∂"),
        CheckConstraint("–ø–ª–æ—â–∞–¥—å > 0", name="check_–ø–ª–æ—â–∞–¥—å"),
        CheckConstraint("—Å—Ç–æ–∏–º–æ—Å—Ç—å > 0", name="check_—Å—Ç–æ–∏–º–æ—Å—Ç—å"),
        CheckConstraint("—Å—Ç–∞—Ç—É—Å IN ('—Å–≤–æ–±–æ–¥–µ–Ω', '–∞—Ä–µ–Ω–¥—É–µ—Ç—Å—è', '–≤ —Ä–µ–∑–µ—Ä–≤–µ', '–Ω–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏')", name="check_—Å—Ç–∞—Ç—É—Å_–æ—Ñ–∏—Å–∞"),
    )

class Contract(Base):
    __tablename__ = "–¥–æ–≥–æ–≤–æ—Ä"

    id_–¥–æ–≥–æ–≤–æ—Ä–∞ = Column(Integer, primary_key=True, index=True)
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ = Column(Integer, ForeignKey("–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞", ondelete="CASCADE"), nullable=False)
    id_–æ—Ñ–∏—Å–∞ = Column(Integer, ForeignKey("–æ—Ñ–∏—Å.id_–æ—Ñ–∏—Å–∞", ondelete="CASCADE"), nullable=False)
    –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞ = Column(Date, nullable=False)
    –¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è = Column(Date, nullable=False)
    —Å—Ç–æ–∏–º–æ—Å—Ç—å = Column(Integer, nullable=False)
    –¥–∞—Ç–∞_–∑–∞–∫–ª—é—á–µ–Ω–∏—è = Column(Date, nullable=False, server_default=func.current_date())
    —Å—Ç–∞—Ç—É—Å = Column(String(20), nullable=False)

    __table_args__ = (
        CheckConstraint("—Å—Ç–æ–∏–º–æ—Å—Ç—å > 0", name="check_—Å—Ç–æ–∏–º–æ—Å—Ç—å_–¥–æ–≥–æ–≤–æ—Ä–∞"),
        CheckConstraint("–¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è >= –¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞", name="check_–¥–∞—Ç—ã_–¥–æ–≥–æ–≤–æ—Ä–∞"),
        CheckConstraint("—Å—Ç–∞—Ç—É—Å IN ('–∞–∫—Ç–∏–≤–µ–Ω', '–∑–∞–≤–µ—Ä—à—ë–Ω', '—Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç')", name="check_—Å—Ç–∞—Ç—É—Å_–¥–æ–≥–æ–≤–æ—Ä–∞"),
    )

    # —Å–≤—è–∑–∏
    –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä = relationship("Tenant", backref="–¥–æ–≥–æ–≤–æ—Ä–∞")
    –æ—Ñ–∏—Å = relationship("Office", backref="–¥–æ–≥–æ–≤–æ—Ä–∞")



class Payment(Base):
    __tablename__ = "–ø–ª–∞—Ç–µ–∂"

    id_–ø–ª–∞—Ç–µ–∂–∞ = Column(Integer, primary_key=True, index=True)
    id_–¥–æ–≥–æ–≤–æ—Ä–∞ = Column(Integer, ForeignKey("–¥–æ–≥–æ–≤–æ—Ä.id_–¥–æ–≥–æ–≤–æ—Ä–∞", ondelete="CASCADE"), nullable=False)
    –¥–∞—Ç–∞_—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è = Column(Date, nullable=False, server_default=func.current_date())
    —Å—Ä–æ–∫_–æ–ø–ª–∞—Ç—ã = Column(Date, nullable=False)
    —Å—É–º–º–∞ = Column(Integer, nullable=False)
    –¥–∞—Ç–∞_–ø–ª–∞—Ç–µ–∂–∞ = Column(Date, nullable=True)
    —Å—Ç–∞—Ç—É—Å = Column(String(20), nullable=False)

    __table_args__ = (
        CheckConstraint("—Å—É–º–º–∞ > 0", name="check_—Å—É–º–º–∞_–ø–ª–∞—Ç–µ–∂–∞"),
        CheckConstraint("—Å—Ç–∞—Ç—É—Å IN ('–Ω–µ –æ–ø–ª–∞—á–µ–Ω', '–æ–ø–ª–∞—á–µ–Ω', '–ø—Ä–æ—Å—Ä–æ—á–µ–Ω')", name="check_—Å—Ç–∞—Ç—É—Å_–ø–ª–∞—Ç–µ–∂–∞"),
    )

    –¥–æ–≥–æ–≤–æ—Ä = relationship("Contract", backref="–ø–ª–∞—Ç–µ–∂–∏")


class Request(Base):
    __tablename__ = "–∑–∞—è–≤–∫–∞"

    id_–∑–∞—è–≤–∫–∏ = Column(Integer, primary_key=True, index=True)
    id_–¥–æ–≥–æ–≤–æ—Ä–∞ = Column(Integer, ForeignKey("–¥–æ–≥–æ–≤–æ—Ä.id_–¥–æ–≥–æ–≤–æ—Ä–∞", ondelete="CASCADE"), nullable=False)
    –¥–∞—Ç–∞_–ø–æ–¥–∞—á–∏ = Column(Date, nullable=False, server_default=func.current_date())
    —Å—Ç–∞—Ç—É—Å = Column(String(20), nullable=False)
    —Ç–µ–∫—Å—Ç_–∑–∞—è–≤–∫–∏ = Column(String(500), nullable=False)

    __table_args__ = (
        CheckConstraint("—Å—Ç–∞—Ç—É—Å IN ('–Ω–æ–≤–∞—è', '–≤ —Ä–∞–±–æ—Ç–µ', '–≤—ã–ø–æ–ª–Ω–µ–Ω–∞', '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞')", name="check_—Å—Ç–∞—Ç—É—Å_–∑–∞—è–≤–∫–∏"),
    )

    –¥–æ–≥–æ–≤–æ—Ä = relationship("Contract", backref="–∑–∞—è–≤–∫–∏")\


class Booking(Base):
    __tablename__ = "–±—Ä–æ–Ω—å"

    id_–±—Ä–æ–Ω–∏ = Column(Integer, primary_key=True, index=True)
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ = Column(Integer, ForeignKey("–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞", ondelete="CASCADE"), nullable=False)
    id_–æ—Ñ–∏—Å–∞ = Column(Integer, ForeignKey("–æ—Ñ–∏—Å.id_–æ—Ñ–∏—Å–∞", ondelete="CASCADE"), nullable=False)
    –¥–∞—Ç–∞_–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è = Column(Date, nullable=False, server_default=func.current_date())
    –Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏ = Column(Date, nullable=False)
    –æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏ = Column(Date, nullable=False)
    —Å—Ç–∞—Ç—É—Å = Column(String(20), nullable=False)

    __table_args__ = (
        CheckConstraint("–æ–∫–æ–Ω—á–∞–Ω–∏–µ_–±—Ä–æ–Ω–∏ >= –Ω–∞—á–∞–ª–æ_–±—Ä–æ–Ω–∏", name="check_–¥–∞—Ç—ã_–±—Ä–æ–Ω–∏"),
        CheckConstraint("—Å—Ç–∞—Ç—É—Å IN ('–∞–∫—Ç–∏–≤–Ω–∞', '–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞', '–∏—Å—Ç–µ–∫–ª–∞')", name="check_—Å—Ç–∞—Ç—É—Å_–±—Ä–æ–Ω–∏"),
    )

    –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä = relationship("Tenant", backref="–±—Ä–æ–Ω–∏")
    –æ—Ñ–∏—Å = relationship("Office", backref="–±—Ä–æ–Ω–∏")


class User(Base):
    __tablename__ = "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    id = Column(Integer, primary_key=True, index=True)
    phone = Column(String(100), unique=True, nullable=False)  # –ª–æ–≥–∏–Ω/—Ç–µ–ª–µ—Ñ–æ–Ω
    hashed_password = Column(String(255), nullable=False)
    role = Column(String(20), nullable=False)  # 'admin' –∏–ª–∏ 'tenant'
    id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ = Column(Integer, ForeignKey("–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä.id_–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞", ondelete="CASCADE"), nullable=True)

    –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä = relationship("Tenant", backref="user")

    __table_args__ = (
        CheckConstraint("role IN ('admin','tenant','staff')"),
    )
